version: '3.9'

services:
  hapi-fhir:
    image: hapiproject/hapi:v5.7.0
    environment:
      - spring.datasource.url=jdbc:postgresql://${POSTGRES_REPLICA_SET:-postgres-1:5432,postgres-2:5432,postgres-3:5432}/${HF_POSTGRES_DB:-hapi}
      - spring.datasource.username=${HF_POSTGRES_USERNAME:-admin}
      - spring.datasource.password=${HF_POSTGRES_PASSWORD:-instant101}
      - spring.datasource.driverClassName=org.postgresql.Driver
      - spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQL95Dialect
      - hapi.fhir.allow_external_references=true
      - hapi.fhir.bulk_export_enabled=true
      - hapi.fhir.enable_repository_validating_interceptor=true
      - JAVA_TOOL_OPTIONS=-Xmx2g
      - CATALINA_OPTS=-Xmx2g
    deploy:
      replicas: ${HAPI_FHIR_INSTANCES:-1}
      resources:
        limits:
          cpus: ${HAPI_FHIR_CPU_LIMIT:-0.8}
          memory: ${HAPI_FHIR_MEMORY_LIMIT:-3G}
        reservations:
          cpus: ${HAPI_FHIR_CPU_RESERVE:-0.05}
          memory: ${HAPI_FHIR_MEMORY_RESERVE:-500M}
